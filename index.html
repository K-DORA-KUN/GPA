<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Tính Điểm GPA Hiện Đại</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Thêm thư viện SheetJS để xuất Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Tông màu xanh biển nhạt mới */
            --primary-bg: #f0f9ff; /* light-sky-100 */
            --container-bg: #ffffff;
            --header-bg: #0369a1; /* sky-700 */
            --header-text: #ffffff;
            --primary-text: #0c4a6e; /* sky-900 */
            --secondary-text: #6b7280;
            --accent-color: #0ea5e9; /* sky-500 */
            --accent-hover: #0284c7; /* sky-600 */
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --success-color: #10b981;
            --border-color: #e5e7eb;
        }
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
        }
        .table-header th {
            position: sticky;
            top: 0;
            background-color: var(--header-bg);
            color: var(--header-text);
            z-index: 10;
        }
        .details-row {
            display: none;
        }
        .details-row.show {
            display: table-row;
        }
        input[type="number"], input[type="text"] {
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover {
            background-color: var(--danger-hover);
        }
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-text);
            transition: color 0.2s;
        }
        .icon-btn:hover {
            color: var(--primary-text);
        }
        .icon-btn.delete:hover {
            color: var(--danger-color);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: all 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-container-bg rounded-xl shadow-lg p-6 md:p-8 fade-in">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 via-teal-500 to-sky-500">
                Bảng Điểm GPA Thông Minh
            </h1>
            <p class="text-gray-500 mt-2 text-lg">Quản lý, tính toán và dự đoán kết quả học tập của bạn</p>
        </header>

        <main id="semesters-container">
            </main>

        <div class="flex justify-center mt-8 space-x-4">
            <button id="add-semester-btn" class="action-btn btn-primary">
                <i class="fas fa-plus"></i>
                <span>Thêm Học Kỳ</span>
            </button>
            <!-- Nút Xuất Excel mới -->
            <button id="export-excel-btn" class="action-btn btn-primary bg-green-600 hover:bg-green-700">
                <i class="fas fa-file-excel"></i>
                <span>Xuất Excel</span>
            </button>
        </div>

        <footer id="summary-container" class="mt-10 p-6 bg-sky-50 rounded-lg">
            </footer>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Xác nhận</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Bạn có chắc chắn muốn thực hiện hành động này?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="action-btn bg-gray-200 text-gray-800 hover:bg-gray-300">Hủy bỏ</button>
                <button id="modal-confirm-btn" class="action-btn btn-danger">Xác nhận</button>
            </div>
        </div>
    </div>

    <script>
        // --- DỮ LIỆU & LƯU TRỮ ---
        let semestersData = [];

        function saveData() {
            localStorage.setItem('gpaData', JSON.stringify(semestersData));
        }

        function loadData() {
            const savedData = localStorage.getItem('gpaData');
            if (savedData) {
                semestersData = JSON.parse(savedData);
            } else {
                semestersData = [
                    {
                        name: "Học kỳ 1",
                        courses: [
                            { code: "COMP1010", name: "Lập trình cơ bản", credits: 3, components: [{ name: "Điểm thi giữa học phần", weight: 50, score: 5.6 }, { name: "Điểm thi kết thúc học phần", weight: 50, score: 4.5 }] },
                            { code: "COMP1600", name: "Cơ sở toán trong CNTT", credits: 4, components: [{ name: "Điểm quá trình", weight: 40, score: 9.5 }, { name: "Điểm thi kết thúc học phần", weight: 60, score: 7.0 }] }
                        ]
                    }
                ];
            }
        }

        // --- CÁC HÀM TÍNH TOÁN ---
        function convertScore(score10) {
            if (score10 === null || isNaN(score10)) return { score4: 0, letter: 'N/A', passed: false, color: 'text-gray-500' };
            if (score10 >= 8.5) return { score4: 4.0, letter: 'A', passed: true, color: 'text-green-500' };
            if (score10 >= 8.0) return { score4: 3.5, letter: 'B+', passed: true, color: 'text-green-500' };
            if (score10 >= 7.0) return { score4: 3.0, letter: 'B', passed: true, color: 'text-sky-500' };
            if (score10 >= 6.5) return { score4: 2.5, letter: 'C+', passed: true, color: 'text-sky-500' };
            if (score10 >= 5.5) return { score4: 2.0, letter: 'C', passed: true, color: 'text-yellow-500' };
            if (score10 >= 5.0) return { score4: 1.5, letter: 'D+', passed: true, color: 'text-yellow-500' };
            if (score10 >= 4.0) return { score4: 1.0, letter: 'D', passed: true, color: 'text-orange-500' };
            return { score4: 0.0, letter: 'F', passed: false, color: 'text-red-500' };
        }

        function calculateAll() {
            let totalCreditsRegistered = 0;
            let totalCreditsAccumulated = 0;
            let totalWeightedScore = 0;

            semestersData.forEach(semester => {
                let semesterCreditsRegistered = 0;
                let semesterCreditsEarned = 0;
                let semesterWeightedScore = 0;

                semester.courses.forEach(course => {
                    let totalWeight = 0;
                    let weightedScoreSum = 0;
                    course.components.forEach(comp => {
                        const weight = parseFloat(comp.weight) || 0;
                        const score = parseFloat(comp.score);
                        if (!isNaN(score) && weight > 0) {
                            totalWeight += weight;
                            weightedScoreSum += score * weight;
                        }
                    });

                    course.totalWeight = totalWeight;
                    course.score10 = totalWeight > 0 ? (weightedScoreSum / totalWeight) : null;
                    
                    const { score4, letter, passed, color } = convertScore(course.score10);
                    course.score4 = score4;
                    course.letter = letter;
                    course.passed = passed;
                    course.color = color;
                    
                    const credits = parseFloat(course.credits) || 0;
                    if (credits > 0) {
                        semesterCreditsRegistered += credits;
                        if (course.score10 !== null) {
                            totalCreditsRegistered += credits;
                           if (passed) {
                                semesterCreditsEarned += credits;
                                totalCreditsAccumulated += credits;
                                semesterWeightedScore += score4 * credits;
                                totalWeightedScore += score4 * credits;
                            }
                        }
                    }
                });

                semester.gpa = semesterCreditsEarned > 0 ? (semesterWeightedScore / semesterCreditsEarned) : 0;
                semester.creditsRegistered = semesterCreditsRegistered;
                semester.creditsEarned = semesterCreditsEarned;
            });

            const cumulativeGpa = totalCreditsAccumulated > 0 ? (totalWeightedScore / totalCreditsAccumulated) : 0;
            
            return { totalCreditsRegistered, totalCreditsAccumulated, cumulativeGpa };
        }

        // --- CÁC HÀM HIỂN THỊ (RENDER) ---
        const semestersContainer = document.getElementById('semesters-container');
        const summaryContainer = document.getElementById('summary-container');
        
        function rerenderAll() {
            const summary = calculateAll();
            semestersContainer.innerHTML = '';
            semestersData.forEach((semester, semesterIndex) => {
                semestersContainer.appendChild(createSemesterElement(semester, semesterIndex));
            });
            summaryContainer.innerHTML = createSummaryElement(summary);
            addEventListeners(); // Gọi lại để đảm bảo các sự kiện được gắn lại sau khi render
            saveData();
        }
        
        function updateUI() {
            const summary = calculateAll();
            summaryContainer.innerHTML = createSummaryElement(summary);
            
            semestersData.forEach((semester, semesterIndex) => {
                const semesterDiv = semestersContainer.querySelector(`[data-semester-container-index="${semesterIndex}"]`);
                if(semesterDiv){
                    const semesterSummaryDiv = semesterDiv.querySelector('.semester-summary');
                    semesterSummaryDiv.innerHTML = `
                        <span>TC ĐK: <strong class="text-blue-600">${semester.creditsRegistered}</strong></span>
                        <span>TC Đạt: <strong class="text-green-600">${semester.creditsEarned}</strong></span>
                        <span>GPA Kỳ: <strong class="text-purple-600">${semester.gpa.toFixed(2)}</strong></span>
                    `;

                    semester.courses.forEach((course, courseIndex) => {
                         const mainRow = semesterDiv.querySelector(`[data-course-row-index="${courseIndex}"]`);
                         if(mainRow){
                            const score10Display = course.score10 !== null ? course.score10.toFixed(2) : '—';
                            const resultIcon = course.score10 !== null ? (course.passed 
                                ? `<i class="fas fa-check-circle text-xl text-green-500"></i>` 
                                : `<i class="fas fa-times-circle text-xl text-red-500"></i>`) : '—';
                            
                            mainRow.cells[4].textContent = score10Display;
                            mainRow.cells[5].className = `p-3 text-center text-lg font-bold ${course.color}`;
                            mainRow.cells[5].textContent = course.letter;
                            mainRow.cells[6].innerHTML = resultIcon;

                            const detailsRow = mainRow.nextElementSibling;
                             if(detailsRow){
                                 const weightWarning = course.totalWeight !== 100 ? `<i class="fas fa-exclamation-triangle text-yellow-500 ml-2" title="Tổng trọng số khác 100%"></i>` : '';
                                 const weightSpan = detailsRow.querySelector('.total-weight-display');
                                 if (weightSpan) {
                                     weightSpan.innerHTML = `Tổng trọng số: <strong class="${course.totalWeight === 100 ? 'text-green-600' : 'text-red-600'}">${course.totalWeight}%</strong>${weightWarning}`;
                                 }
                             }
                         }
                    });
                }
            });
            saveData();
        }

        function createSemesterElement(semester, semesterIndex) {
            const semesterDiv = document.createElement('div');
            semesterDiv.className = 'semester-container mb-8 bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 fade-in';
            semesterDiv.dataset.semesterContainerIndex = semesterIndex;
            semesterDiv.innerHTML = `
                <div class="bg-gray-50 p-4 flex justify-between items-center border-b border-gray-200">
                    <input type="text" value="${semester.name}" class="semester-name-input text-xl font-bold text-gray-700 bg-transparent border-none focus:ring-0 p-0" data-semester-index="${semesterIndex}">
                    <button class="action-btn btn-danger text-sm remove-semester-btn" data-semester-index="${semesterIndex}"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-blue-800"><tr class="table-header">
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider w-12">STT</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider w-40">Mã môn học</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Tên môn học</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Số TC</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Điểm H10</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Điểm Chữ</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Kết Quả</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Thao tác</th>
                        </tr></thead>
                        <tbody class="divide-y divide-gray-200 courses-tbody">
                            ${semester.courses.map((course, courseIndex) => createCourseRow(course, semesterIndex, courseIndex)).join('')}
                            ${semester.courses.length === 0 ? `<tr><td colspan="8" class="empty-course-msg text-center p-8 text-gray-500">Chưa có môn học nào. Hãy thêm một môn!</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
                <div class="p-4 bg-gray-50 flex justify-between items-center border-t">
                     <div class="semester-summary text-sm font-semibold text-gray-600 space-x-4">
                        <span>TC ĐK: <strong class="text-blue-600">${semester.creditsRegistered}</strong></span>
                        <span>TC Đạt: <strong class="text-green-600">${semester.creditsEarned}</strong></span>
                        <span>GPA Kỳ: <strong class="text-purple-600">${semester.gpa.toFixed(2)}</strong></span>
                    </div>
                    <button class="add-course-btn action-btn btn-primary text-sm" data-semester-index="${semesterIndex}"><i class="fas fa-plus"></i> Thêm Môn</button>
                </div>
            `;
            return semesterDiv;
        }

        function createCourseRow(course, semesterIndex, courseIndex) {
            const score10Display = course.score10 !== null ? course.score10.toFixed(2) : '—';
            const resultIcon = course.score10 !== null ? (course.passed 
                ? `<i class="fas fa-check-circle text-xl text-green-500"></i>` 
                : `<i class="fas fa-times-circle text-xl text-red-500"></i>`) : '—';
            const weightWarning = course.totalWeight !== 100 ? `<i class="fas fa-exclamation-triangle text-yellow-500 ml-2" title="Tổng trọng số khác 100%"></i>` : '';

            const rowHtml = `
                <tr class="course-row hover:bg-gray-50" data-course-row-index="${courseIndex}">
                    <td class="p-3 text-center text-sm font-medium text-gray-500">${courseIndex + 1}</td>
                    <td class="p-3"><input type="text" value="${course.code}" class="course-data-input w-full p-1 rounded" data-field="code" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"></td>
                    <td class="p-3"><input type="text" value="${course.name}" class="course-data-input w-full p-1 rounded" data-field="name" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"></td>
                    <td class="p-3"><input type="number" value="${course.credits}" min="0" step="1" class="course-data-input w-full p-1 rounded text-center" data-field="credits" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"></td>
                    <td class="p-3 text-center text-lg font-bold text-blue-600">${score10Display}</td>
                    <td class="p-3 text-center text-lg font-bold ${course.color}">${course.letter}</td>
                    <td class="p-3 text-center">${resultIcon}</td>
                    <td class="p-3 text-center">
                        <button class="icon-btn toggle-details-btn" title="Xem chi tiết" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"><i class="fas fa-chevron-down"></i></button>
                        <button class="icon-btn delete remove-course-btn" title="Xóa môn học" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
                <tr class="details-row"><td colspan="8" class="p-0"><div class="bg-indigo-50 p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-gray-700">Chi tiết điểm: ${course.name}</h4>
                        <span class="total-weight-display text-sm font-medium text-gray-600">Tổng trọng số: <strong class="${course.totalWeight === 100 ? 'text-green-600' : 'text-red-600'}">${course.totalWeight}%</strong>${weightWarning}</span>
                    </div>
                    <table class="min-w-full">
                        <tbody class="components-tbody">
                            ${course.components.map((comp, compIndex) => createComponentRow(comp, semesterIndex, courseIndex, compIndex)).join('')}
                        </tbody>
                    </table>
                    <button class="add-component-btn mt-2 text-sm text-indigo-600 font-semibold hover:text-indigo-800" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"><i class="fas fa-plus mr-1"></i>Thêm thành phần</button>
                </div></td></tr>
            `;
            return rowHtml;
        }

        function createComponentRow(comp, semesterIndex, courseIndex, compIndex) {
            return `
                <tr class="group" data-comp-index="${compIndex}">
                    <td class="p-2 w-2/3"><input type="text" value="${comp.name}" class="comp-data-input w-full p-1 rounded bg-white" data-field="name" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${compIndex}"></td>
                    <td class="p-2"><input type="number" value="${comp.weight}" placeholder="%" min="0" max="100" class="comp-data-input w-full p-1 rounded text-center bg-white" data-field="weight" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${compIndex}"></td>
                    <td class="p-2"><input type="number" value="${comp.score}" placeholder="Điểm" min="0" max="10" step="0.1" class="comp-data-input w-full p-1 rounded text-center bg-white" data-field="score" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${compIndex}"></td>
                    <td class="p-2 text-center w-12"><button class="icon-btn delete remove-component-btn opacity-50 group-hover:opacity-100" title="Xóa thành phần" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${compIndex}"><i class="fas fa-minus-circle"></i></button></td>
                </tr>`;
        }
        
        function createSummaryElement(summary) {
            const summaryItems = [
                { icon: 'fa-layer-group', label: 'Tổng TC Đăng Ký', value: summary.totalCreditsRegistered, color: 'text-blue-500' },
                { icon: 'fa-check-double', label: 'Tổng TC Tích Lũy', value: summary.totalCreditsAccumulated, color: 'text-green-500' },
                { icon: 'fa-graduation-cap', label: 'GPA Tích Lũy', value: summary.cumulativeGpa.toFixed(3), color: 'text-purple-500' }
            ];
            return `
                <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Tổng Kết Toàn Khóa</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${summaryItems.map(item => `
                        <div class="bg-white p-6 rounded-lg shadow-sm flex items-center gap-4">
                            <i class="fas ${item.icon} ${item.color} text-3xl"></i>
                            <div>
                                <p class="text-sm text-gray-500">${item.label}</p>
                                <p class="text-3xl font-bold ${item.color}">${item.value}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- MODAL & SỰ KIỆN ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let confirmCallback = null;

        function showModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            modal.classList.add('visible');
        }

        function hideModal() {
            modal.classList.remove('visible');
            confirmCallback = null;
        }

        modalConfirmBtn.onclick = () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideModal();
        };
        modalCancelBtn.onclick = hideModal;
        modal.onclick = (e) => { if (e.target === modal) hideModal(); };

        function addEventListeners() {
            // Sự kiện chỉ cần gắn một lần bằng event delegation
            // (Hàm này có thể trống vì chúng ta dùng event delegation trên document.body)
        }
        
        // --- CÁC HÀM XUẤT DỮ LIỆU ---
function exportToExcel() {
    if (semestersData.length === 0) {
        showModal('Không có dữ liệu', 'Không có dữ liệu học kỳ nào để xuất ra Excel.', () => {});
        return;
    }

    const workbook = XLSX.utils.book_new();
    const date = new Date().toLocaleDateString('vi-VN');
    const time = new Date().toLocaleTimeString('vi-VN');

    // Tạo sheet thông tin chung
    const infoData = [
        ["BẢNG ĐIỂM GPA", "", "", "", "", "", ""],
        ["Người dùng:", "Học sinh/Sinh viên", "", "", "", "", ""],
        ["Ngày xuất:", date, "Lúc:", time, "", "", ""],
        ["", "", "", "", "", "", ""],
        ["TỔNG HỢP", "", "", "", "", "", ""],
        ["Tổng số học kỳ:", semestersData.length, "", "", "", "", ""],
        ["Tổng số môn học:", semestersData.reduce((sum, semester) => sum + semester.courses.length, 0), "", "", "", "", ""],
        ["Tổng số tín chỉ đăng ký:", calculateAll().totalCreditsRegistered, "", "", "", "", ""],
        ["Tổng số tín chỉ tích lũy:", calculateAll().totalCreditsAccumulated, "", "", "", "", ""],
        ["GPA tích lũy:", calculateAll().cumulativeGpa.toFixed(3), "Xếp loại:", getGradeClassification(calculateAll().cumulativeGpa), "", "", ""],
        ["", "", "", "", "", "", ""],
        ["Ghi chú:", "", "", "", "", "", ""],
        ["- Điểm số được tính theo thang điểm 10", "", "", "", "", "", ""],
        ["- GPA được tính theo thang điểm 4", "", "", "", "", "", ""],
        ["- Tổng trọng số các thành phần điểm phải bằng 100%", "", "", "", "", "", ""]
    ];
    
    const wsInfo = XLSX.utils.aoa_to_sheet(infoData);
    XLSX.utils.book_append_sheet(workbook, wsInfo, "Thông tin");

    // Tạo sheet cho từng học kỳ
    semestersData.forEach((semester, semesterIdx) => {
        const semesterName = semester.name || `Học kỳ ${semesterIdx + 1}`;
        const data = [];

        // Tiêu đề học kỳ
        data.push([semesterName.toUpperCase(), "", "", "", "", "", ""]);
        data.push(["", "", "", "", "", "", ""]);

        // Header cho bảng môn học
        data.push(["STT", "Mã môn", "Tên môn học", "Số TC", "Điểm H10", "Điểm Chữ", "Kết Quả"]);

        semester.courses.forEach((course, courseIdx) => {
            const score10Display = course.score10 !== null ? course.score10.toFixed(2) : '—';
            const result = course.score10 !== null ? (course.passed ? 'Đạt' : 'Trượt') : '—';
            
            // Thêm dữ liệu môn học
            data.push([
                courseIdx + 1,
                course.code,
                course.name,
                course.credits,
                { v: course.score10, t: 'n', z: course.score10 !== null ? '0.00' : '@' },
                course.letter,
                result
            ]);

            // Thêm chi tiết điểm
            if (course.components && course.components.length > 0) {
                data.push(["", "", "Thành phần điểm", "Trọng số (%)", "Điểm", "Ghi chú", ""]);
                
                course.components.forEach(comp => {
                    data.push([
                        "", 
                        "", 
                        comp.name, 
                        { v: comp.weight, t: 'n', z: '0' },
                        { v: comp.score, t: 'n', z: comp.score !== null ? '0.0' : '@' },
                        "", 
                        ""
                    ]);
                });
                
                // Thêm dòng tổng trọng số
                const weightStatus = course.totalWeight === 100 ? "✓ Đạt" : "⚠ Chưa đạt (Tổng: " + course.totalWeight + "%)";
                data.push([
                    "", 
                    "", 
                    "Tổng trọng số:", 
                    course.totalWeight + "%", 
                    "", 
                    weightStatus, 
                    ""
                ]);
                
                // Thêm dòng điểm tổng kết
                data.push([
                    "", 
                    "", 
                    "Điểm tổng kết:", 
                    "", 
                    score10Display, 
                    course.letter + " (" + convertScore(course.score10).score4.toFixed(2) + "/4.0)", 
                    ""
                ]);
                
                data.push(["", "", "", "", "", "", ""]); // Dòng trống
            }
        });

        // Thêm tóm tắt học kỳ
        data.push(["", "", "TÓM TẮT HỌC KỲ", "", "", "", ""]);
        data.push(["", "", "Tín chỉ đăng ký:", semester.creditsRegistered, "", "", ""]);
        data.push(["", "", "Tín chỉ đạt:", semester.creditsEarned, "", "", ""]);
        data.push(["", "", "GPA học kỳ:", { v: semester.gpa, t: 'n', z: '0.00' }, "", "", ""]);
        data.push(["", "", "Xếp loại:", getGradeClassification(semester.gpa), "", "", ""]);
        data.push(["", "", "", "", "", "", ""]); // Dòng trống

        // Định dạng cột
        const colWidths = [
            { wch: 5 },  // STT
            { wch: 12 }, // Mã môn
            { wch: 30 }, // Tên môn
            { wch: 8 },  // Số TC
            { wch: 10 }, // Điểm H10
            { wch: 15 }, // Điểm chữ
            { wch: 10 }  // Kết quả
        ];

        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = colWidths;
        
        // Thêm định dạng điều kiện cho điểm
        if (semester.courses.some(c => c.score10 !== null)) {
            ws['!conditionalFormats'] = [
                {
                    ref: `E4:E${3 + semester.courses.length}`,
                    rules: [
                        { type: 'cell', op: 'lte', val: 4, color: { rgb: 'FF0000' } }, // Đỏ cho điểm <= 4
                        { type: 'cell', op: 'between', val: [4, 5.5], color: { rgb: 'FFA500' } }, // Cam cho 4-5.5
                        { type: 'cell', op: 'between', val: [5.5, 7], color: { rgb: 'FFFF00' } }, // Vàng cho 5.5-7
                        { type: 'cell', op: 'between', val: [7, 8.5], color: { rgb: '90EE90' } }, // Xanh nhạt cho 7-8.5
                        { type: 'cell', op: 'gte', val: 8.5, color: { rgb: '008000' } } // Xanh đậm cho >=8.5
                    ]
                }
            ];
        }

        XLSX.utils.book_append_sheet(workbook, ws, semesterName.substring(0, 31));
    });

    // Thêm sheet tổng kết toàn khóa
    const summary = calculateAll();
    const summaryData = [
        ["TỔNG KẾT TOÀN KHÓA"],
        ["", "", "", "", "", "", ""],
        ["Tổng số học kỳ:", semestersData.length, "", "", "", "", ""],
        ["Tổng số môn học:", semestersData.reduce((sum, semester) => sum + semester.courses.length, 0), "", "", "", "", ""],
        ["Tổng tín chỉ đăng ký:", summary.totalCreditsRegistered, "", "", "", "", ""],
        ["Tổng tín chỉ tích lũy:", summary.totalCreditsAccumulated, "", "", "", "", ""],
        ["GPA tích lũy:", { v: summary.cumulativeGpa, t: 'n', z: '0.000' }, "", "", "", "", ""],
        ["Xếp loại:", getGradeClassification(summary.cumulativeGpa), "", "", "", "", ""],
        ["", "", "", "", "", "", ""],
        ["THANG ĐIỂM CHUẨN", "", "", "", "", "", ""],
        ["Điểm H10", "Điểm chữ", "Điểm H4", "Đánh giá", "", "", ""],
        ["9.0 - 10", "A", "4.0", "Xuất sắc", "", "", ""],
        ["8.0 - 8.9", "B+", "3.5", "Giỏi", "", "", ""],
        ["7.0 - 7.9", "B", "3.0", "Khá", "", "", ""],
        ["6.5 - 6.9", "C+", "2.5", "Trung bình khá", "", "", ""],
        ["5.5 - 6.4", "C", "2.0", "Trung bình", "", "", ""],
        ["5.0 - 5.4", "D+", "1.5", "Trung bình yếu", "", "", ""],
        ["4.0 - 4.9", "D", "1.0", "Yếu", "", "", ""],
        ["0 - 3.9", "F", "0.0", "Trượt", "", "", ""]
    ];
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    wsSummary['!cols'] = [
        { wch: 20 }, // Cột 1
        { wch: 10 }, // Cột 2
        { wch: 10 }, // Cột 3
        { wch: 20 }, // Cột 4
        { wch: 5 },  // Cột 5
        { wch: 5 },  // Cột 6
        { wch: 5 }   // Cột 7
    ];
    
    // Định dạng điều kiện cho bảng thang điểm
    wsSummary['!conditionalFormats'] = [
        {
            ref: "A12:A19",
            rules: [
                { type: 'cell', op: 'between', val: [9, 10], color: { rgb: '008000' } }, // Xanh đậm
                { type: 'cell', op: 'between', val: [8, 8.9], color: { rgb: '90EE90' } }, // Xanh nhạt
                { type: 'cell', op: 'between', val: [7, 7.9], color: { rgb: 'FFFF00' } }, // Vàng
                { type: 'cell', op: 'between', val: [6.5, 6.9], color: { rgb: 'FFA500' } }, // Cam
                { type: 'cell', op: 'lte', val: 6.4, color: { rgb: 'FF0000' } } // Đỏ
            ]
        }
    ];
    
    XLSX.utils.book_append_sheet(workbook, wsSummary, "Tổng Kết");

    // Xuất file
    const fileName = `Bảng điểm GPA - ${date.replace(/\//g, '-')}.xlsx`;
    XLSX.writeFile(workbook, fileName);
}

function getGradeClassification(gpa) {
    if (gpa >= 3.6) return "Xuất sắc";
    if (gpa >= 3.2) return "Giỏi";
    if (gpa >= 2.5) return "Khá";
    if (gpa >= 2.0) return "Trung bình";
    return "Yếu";
}

        // --- SỬ DỤNG EVENT DELEGATION ĐỂ QUẢN LÝ SỰ KIỆN ---
        document.body.addEventListener('click', (e) => {
            const target = e.target;

            // Thêm học kỳ
            if (target.matches('#add-semester-btn') || target.closest('#add-semester-btn')) {
                const newSemesterIndex = semestersData.length;
                semestersData.push({ name: `Học kỳ mới ${newSemesterIndex + 1}`, courses: [] });
                calculateAll(); // Tính toán lại trước khi render
                const newSemesterElement = createSemesterElement(semestersData[newSemesterIndex], newSemesterIndex);
                semestersContainer.appendChild(newSemesterElement);
                updateUI();
                return;
            }

            // Xuất Excel
            const exportExcelBtn = target.closest('#export-excel-btn');
            if (exportExcelBtn) {
                exportToExcel();
                return;
            }

            // Xóa học kỳ
            const removeSemesterBtn = target.closest('.remove-semester-btn');
            if(removeSemesterBtn){
                const semesterIndex = parseInt(removeSemesterBtn.dataset.semesterIndex);
                showModal('Xóa Học Kỳ?', `Bạn có chắc muốn xóa học kỳ "${semestersData[semesterIndex].name}" và tất cả môn học trong đó?`, () => {
                    semestersData.splice(semesterIndex, 1);
                    rerenderAll(); // Xóa học kỳ cần render lại để cập nhật index
                });
                return;
            }

            // Thêm môn học
            const addCourseBtn = target.closest('.add-course-btn');
            if(addCourseBtn){
                const semesterIndex = parseInt(addCourseBtn.dataset.semesterIndex);
                const courseIndex = semestersData[semesterIndex].courses.length;
                semestersData[semesterIndex].courses.push({ code: "", name: "Môn học mới", credits: 0, components: [{ name: "Điểm tổng kết", weight: 100, score: null }] });
                
                const courseContainer = addCourseBtn.closest('.semester-container').querySelector('.courses-tbody');
                const emptyMsg = courseContainer.querySelector('.empty-course-msg');
                if(emptyMsg) emptyMsg.parentElement.remove();
                
                calculateAll();
                const newCourseRow = createCourseRow(semestersData[semesterIndex].courses[courseIndex], semesterIndex, courseIndex);
                courseContainer.insertAdjacentHTML('beforeend', newCourseRow);
                updateUI();
                return;
            }

            // Xóa môn học
            const removeCourseBtn = target.closest('.remove-course-btn');
            if(removeCourseBtn){
                const { semesterIndex, courseIndex } = removeCourseBtn.dataset;
                showModal('Xóa Môn Học?', `Bạn có chắc muốn xóa môn "${semestersData[semesterIndex].courses[courseIndex].name}"?`, () => {
                    semestersData[semesterIndex].courses.splice(courseIndex, 1);
                    rerenderAll(); // Xóa môn học cần render lại để cập nhật index
                });
                return;
            }
            
            // Xóa thành phần điểm
            const removeComponentBtn = target.closest('.remove-component-btn');
            if(removeComponentBtn){
                 const { semesterIndex, courseIndex, compIndex } = removeComponentBtn.dataset;
                 const components = semestersData[semesterIndex].courses[courseIndex].components;
                 if (components.length > 1) {
                     components.splice(compIndex, 1);
                     updateUI(); // Chỉ cần cập nhật UI thay vì render lại toàn bộ
                 } else {
                     showModal('Không thể xóa', 'Mỗi môn học phải có ít nhất một thành phần điểm.', () => {});
                 }
                 return;
            }
            
            // Thêm thành phần điểm - ĐÃ SỬA
            const addComponentBtn = target.closest('.add-component-btn');
            if(addComponentBtn){
                const { semesterIndex, courseIndex } = addComponentBtn.dataset;
                const newCompIndex = semestersData[semesterIndex].courses[courseIndex].components.length;
                semestersData[semesterIndex].courses[courseIndex].components.push({ 
                    name: "Thành phần mới", 
                    weight: 0, 
                    score: null 
                });
                
                // Thêm dòng mới vào bảng thành phần
                const componentsTbody = addComponentBtn.closest('.details-row').querySelector('.components-tbody');
                const newRow = document.createElement('tr');
                newRow.className = 'group';
                newRow.dataset.compIndex = newCompIndex;
                newRow.innerHTML = `
                    <td class="p-2 w-2/3"><input type="text" value="Thành phần mới" class="comp-data-input w-full p-1 rounded bg-white" data-field="name" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${newCompIndex}"></td>
                    <td class="p-2"><input type="number" value="0" placeholder="%" min="0" max="100" class="comp-data-input w-full p-1 rounded text-center bg-white" data-field="weight" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${newCompIndex}"></td>
                    <td class="p-2"><input type="number" value="" placeholder="Điểm" min="0" max="10" step="0.1" class="comp-data-input w-full p-1 rounded text-center bg-white" data-field="score" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${newCompIndex}"></td>
                    <td class="p-2 text-center w-12"><button class="icon-btn delete remove-component-btn opacity-50 group-hover:opacity-100" title="Xóa thành phần" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${newCompIndex}"><i class="fas fa-minus-circle"></i></button></td>
                `;
                componentsTbody.appendChild(newRow);
                
                updateUI();
                return;
            }

            // Mở/đóng chi tiết môn học
            const toggleBtn = target.closest('.toggle-details-btn');
            if (toggleBtn) {
                const detailsRow = toggleBtn.closest('tr.course-row').nextElementSibling;
                const icon = toggleBtn.querySelector('i');
                detailsRow.classList.toggle('show');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
                return;
            }
        });

        document.body.addEventListener('input', (e) => {
            const target = e.target;
            const { semesterIndex, courseIndex, compIndex, field } = target.dataset;

            if (field) {
                 const value = target.value;
                 if (target.classList.contains('semester-name-input')) {
                     semestersData[semesterIndex].name = value;
                 } else if (target.classList.contains('course-data-input')) {
                     semestersData[semesterIndex].courses[courseIndex][field] = value;
                 } else if (target.classList.contains('comp-data-input')) {
                     semestersData[semesterIndex].courses[courseIndex].components[compIndex][field] = value;
                 }
                 
                 updateUI();
            }
        });

        // --- KHỞI TẠO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            rerenderAll();
        });
        document.onkeydown = function(e) {
    if (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S')) {
        e.preventDefault();
    }
};

    </script>
</body>
</html>