<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Smart_GPA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-bg: #f0f9ff;
            --container-bg: #ffffff;
            --header-bg: #0369a1;
            --header-text: #ffffff;
            --primary-text: #0c4a6e;
            --secondary-text: #6b7280;
            --accent-color: #0ea5e9;
            --accent-hover: #0284c7;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --success-color: #10b981;
            --import-color: #f59e0b;
            --import-hover: #d97706;
            --border-color: #e5e7eb;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--primary-bg); color: var(--primary-text); }
        .table-header th { position: sticky; top: 0; background-color: var(--header-bg); color: var(--header-text); z-index: 10; }
        .details-row { display: none; }
        .details-row.show { display: table-row; }
        input[type="number"], input[type="text"] { transition: all 0.2s ease-in-out; border: 1px solid var(--border-color); }
        input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2); }
        
        .semester-name-input {
            border: 1px dashed transparent !important;
            transition: all 0.2s;
            border-radius: 4px;
            padding: 4px 8px !important;
        }
        .semester-name-input:hover { border-color: #cbd5e1 !important; background-color: #f8fafc; cursor: text; }
        .semester-name-input:focus { border-color: var(--accent-color) !important; background-color: #fff; border-style: solid !important; }

        .action-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-import { background-color: var(--import-color); color: white; }
        .btn-import:hover { background-color: var(--import-hover); transform: translateY(-1px); }

        .icon-btn { background: none; border: none; cursor: pointer; color: var(--secondary-text); transition: color 0.2s; }
        .icon-btn:hover { color: var(--primary-text); }
        .icon-btn.delete:hover { color: var(--danger-color); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: all 0.3s ease-in-out; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        .remove-btn { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .remove-btn:hover { background-color: #fca5a5; border-color: #f87171; }
        .secondary-btn { background-color: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }
        .secondary-btn:hover { background-color: #7dd3fc; border-color: #38bdf8; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-container-bg rounded-xl shadow-lg p-6 md:p-8 fade-in">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 via-teal-500 to-sky-500">
                Bảng Điểm Smart_GPA</span>
            </h1>
            <p class="text-gray-500 mt-2 text-lg">Quản lý, tính toán và dự đoán kết quả học tập</p>
        </header>

        <main id="semesters-container">
        </main>

        <div class="flex justify-center mt-8 space-x-4">
            <button id="add-semester-btn" class="action-btn btn-primary">
                <i class="fas fa-plus"></i>
                <span>Thêm Học Kỳ</span>
            </button>
            <button id="export-excel-btn" class="action-btn btn-primary bg-green-600 hover:bg-green-700">
                <i class="fas fa-file-excel"></i>
                <span>Xuất Excel</span>
            </button>
        </div>

        <footer id="summary-container" class="mt-10 p-6 bg-sky-50 rounded-lg">
        </footer>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Xác nhận</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Nội dung thông báo...</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="action-btn bg-gray-200 text-gray-800 hover:bg-gray-300">Hủy bỏ</button>
                <button id="modal-confirm-btn" class="action-btn btn-danger">Xác nhận</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto mt-6">
        <div class="bg-white p-6 rounded-xl shadow-lg transition-all duration-300">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Tác vụ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="save-data-btn" class="action-btn secondary-btn w-full justify-center">
                    <i class="fas fa-save"></i>
                    <span>Lưu Dữ Liệu</span>
                </button>
                <button id="reset-data-btn" class="action-btn remove-btn w-full justify-center">
                    <i class="fas fa-trash-alt"></i>
                    <span>Đặt Lại Toàn Bộ</span>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- DATA & STORAGE ---
        let semestersData = [];

        function saveData() {
            localStorage.setItem('gpaData', JSON.stringify(semestersData));
            showModal('Đã Lưu Thành Công!', 'Dữ liệu của bạn đã được lưu vào trình duyệt.', null);
        }

        function loadData() {
            const savedData = localStorage.getItem('gpaData');
            if (savedData) {
                semestersData = JSON.parse(savedData);
            } else {
                if (semestersData.length === 0) {
                    semestersData.push({ name: "Học kỳ 1", courses: [] });
                }
            }
        }
        
        function resetData() {
            showModal('Đặt Lại Dữ Liệu?', 'Bạn có chắc chắn muốn xóa tất cả dữ liệu? Hành động này không thể hoàn tác.', () => {
                semestersData = [];
                localStorage.removeItem('gpaData');
                rerenderAll();
            });
        }

        // --- CALCULATION LOGIC ---
        function convertScore(score10) {
            if (score10 === null || isNaN(score10)) return { score4: 0, letter: 'N/A', passed: false, color: 'text-gray-500' };
            if (score10 >= 8.5) return { score4: 4.0, letter: 'A', passed: true, color: 'text-green-500' };
            if (score10 >= 7.8) return { score4: 3.5, letter: 'B+', passed: true, color: 'text-green-500' };
            if (score10 >= 7.0) return { score4: 3.0, letter: 'B', passed: true, color: 'text-sky-500' };
            if (score10 >= 6.3) return { score4: 2.5, letter: 'C+', passed: true, color: 'text-sky-500' };
            if (score10 >= 5.5) return { score4: 2.0, letter: 'C', passed: true, color: 'text-yellow-500' };
            if (score10 >= 4.8) return { score4: 1.5, letter: 'D+', passed: true, color: 'text-yellow-500' };
            if (score10 >= 4.0) return { score4: 1.0, letter: 'D', passed: true, color: 'text-orange-500' };
            return { score4: 0.0, letter: 'F', passed: false, color: 'text-red-500' };
        }

        function calculateAll() {
            let totalCreditsRegistered = 0;
            let totalCreditsAccumulated = 0;
            let totalWeightedScore = 0;

            semestersData.forEach(semester => {
                let semesterCreditsRegistered = 0;
                let semesterCreditsEarned = 0;
                let semesterWeightedScore = 0;

                semester.courses.forEach(course => {
                    let totalWeight = 0;
                    let weightedScoreSum = 0;
                    let hasEmptyScore = false; // Cờ đánh dấu chưa nhập xong

                    // Tự tạo component mặc định nếu chưa có
                    if (course.components.length === 0 && course.score10 !== null) {
                         course.components.push({ name: "Điểm tổng kết", weight: 100, score: course.score10 });
                    }

                    course.components.forEach(comp => {
                        const weight = parseFloat(comp.weight) || 0;
                        const scoreStr = comp.score; // Lấy giá trị thô để kiểm tra rỗng
                        
                        // Kiểm tra xem điểm có bị bỏ trống không
                        if (scoreStr === null || scoreStr === "" || isNaN(parseFloat(scoreStr))) {
                            hasEmptyScore = true;
                        }

                        const score = parseFloat(scoreStr);
                        if (!isNaN(score) && weight > 0) {
                            totalWeight += weight;
                            weightedScoreSum += score * weight;
                        }
                    });

                    course.totalWeight = totalWeight;
                    course.isIncomplete = hasEmptyScore; // Lưu trạng thái vào object môn học
                    
                    if (totalWeight > 0) {
                        let rawScore10 = weightedScoreSum / totalWeight;
                        course.score10 = Math.round(rawScore10 * 10) / 10;
                    } else if (course.score10 !== null && !hasEmptyScore) {
                         // Nếu không có trọng số (nhập thẳng) và đã nhập điểm
                         course.score10 = Math.round(course.score10 * 10) / 10;
                    } else {
                        // Trường hợp chưa nhập gì cả
                        course.score10 = null;
                    }
                    
                    const { score4, letter, passed, color } = convertScore(course.score10);
                    course.score4 = score4;
                    course.letter = letter;
                    course.passed = passed;
                    course.color = color;
                    
                    const credits = parseFloat(course.credits) || 0;
                    if (credits > 0) {
                        semesterCreditsRegistered += credits;
                        // Chỉ tính vào tổng kết nếu ĐÃ CÓ ĐIỂM HỆ 10 (tức là đã nhập đủ để tính ra kết quả)
                        if (course.score10 !== null) {
                            totalCreditsRegistered += credits;
                            if (passed) {
                                semesterCreditsEarned += credits;
                                totalCreditsAccumulated += credits;
                                semesterWeightedScore += score4 * credits;
                                totalWeightedScore += score4 * credits;
                            }
                        }
                    }
                });

                semester.gpa = semesterCreditsEarned > 0 ? (semesterWeightedScore / semesterCreditsEarned) : 0;
                semester.creditsRegistered = semesterCreditsRegistered;
                semester.creditsEarned = semesterCreditsEarned;
            });

            const cumulativeGpa = totalCreditsAccumulated > 0 ? (totalWeightedScore / totalCreditsAccumulated) : 0;
            
            return { totalCreditsRegistered, totalCreditsAccumulated, cumulativeGpa };
        }

        // --- EXCEL IMPORT LOGIC (UPDATED) ---
        function handleImportFile(file, semesterIndex) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                if (jsonData.length < 2) {
                    showModal('Lỗi File', 'File không có dữ liệu.', null);
                    return;
                }

                // --- BƯỚC 1: DỌN DẸP DÒNG TRỐNG ---
                // Trước khi import, xóa các dòng rỗng/rác hiện có trong học kỳ để tránh lỗi "dòng đầu trống"
                const currentCourses = semestersData[semesterIndex].courses;
                if (currentCourses.length > 0) {
                    semestersData[semesterIndex].courses = currentCourses.filter(c => 
                        (c.name && c.name.trim() !== '') || (c.score10 !== null)
                    );
                }

                // --- BƯỚC 2: TÌM DÒNG TIÊU ĐỀ THÔNG MINH ---
                let headerRowIndex = -1;
                let colMap = { code: -1, name: -1, credits: -1, score: -1 };
                
                // Quét 5 dòng đầu
                for(let i = 0; i < Math.min(5, jsonData.length); i++) {
                    const row = jsonData[i].map(cell => String(cell).toLowerCase().trim());
                    
                    row.forEach((cell, idx) => {
                        if(cell.includes('mã') && (cell.includes('môn') || cell.includes('hp') || cell.includes('mh'))) colMap.code = idx;
                        else if(cell.includes('tên') && (cell.includes('môn') || cell.includes('hp') || cell.includes('mh'))) colMap.name = idx;
                        else if(cell.includes('tín') || cell.includes('tc') || cell.includes('dvht')) colMap.credits = idx;
                        else if(cell.includes('điểm') && (cell.includes('10') || cell.includes('tổng') || cell.includes('tk') || cell === 'điểm')) colMap.score = idx;
                    });

                    // Chỉ cần tìm thấy Tên và Tín chỉ là chốt
                    if(colMap.name !== -1 && colMap.credits !== -1) {
                        headerRowIndex = i;
                        break;
                    }
                }

                // --- BƯỚC 3: XỬ LÝ NẾU KHÔNG TÌM THẤY TIÊU ĐỀ (FALLBACK) ---
                if (headerRowIndex === -1) {
                    // Giả định file có STT ở đầu: STT(0), Mã(1), Tên(2), TC(3) -> Khớp với file của bạn
                    colMap = { code: 1, name: 2, credits: 3, score: 4 };
                    // Nếu cột 0 là Mã môn thì dịch chuyển lại
                    const firstRow = jsonData[0] || [];
                    const firstCell = String(firstRow[0]).trim().toUpperCase();
                    if (firstCell.startsWith('IT') || firstCell.startsWith('MA') || firstCell.length > 4) {
                         // File không có STT, bắt đầu luôn bằng Mã
                         colMap = { code: 0, name: 1, credits: 2, score: 3 };
                    }
                    headerRowIndex = -1; 
                }

                let importedCount = 0;
                for(let i = headerRowIndex + 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;

                    const name = colMap.name !== -1 ? row[colMap.name] : '';
                    if (!name) continue; 

                    const code = colMap.code !== -1 ? (row[colMap.code] || '') : '';
                    let credits = colMap.credits !== -1 ? parseInt(row[colMap.credits]) : 0;
                    if (isNaN(credits)) credits = 0; // Fix lỗi NaN

                    let score = null;
                    if (colMap.score !== -1 && row[colMap.score] != null && String(row[colMap.score]).trim() !== '') {
                        score = parseFloat(row[colMap.score]);
                    }

                    // Bỏ qua dòng tiêu đề nếu bị lọt vào (trường hợp fallback)
                    if (String(name).toLowerCase().includes('tên môn')) continue;

                    const newCourse = {
                        code: String(code),
                        name: String(name),
                        credits: credits,
                        score10: isNaN(score) ? null : score,
                        components: [],
                        totalWeight: 100
                    };
                    
                    if (newCourse.score10 !== null) {
                        newCourse.components.push({ name: "Điểm Import", weight: 100, score: newCourse.score10 });
                    } else {
                        newCourse.components.push({ name: "Điểm tổng kết", weight: 100, score: null });
                    }

                    semestersData[semesterIndex].courses.push(newCourse);
                    importedCount++;
                }

                if (importedCount > 0) {
                    showModal('Thành công', `Đã nhập ${importedCount} môn. Lưu ý: Nếu file không có cột điểm, bạn cần tự nhập điểm.`, null);
                    rerenderAll();
                } else {
                    showModal('Thất bại', 'Không đọc được dữ liệu. Vui lòng kiểm tra file.', null);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- UI RENDERING ---
        const semestersContainer = document.getElementById('semesters-container');
        const summaryContainer = document.getElementById('summary-container');
        
        function rerenderAll() {
            const summary = calculateAll();
            semestersContainer.innerHTML = '';
            semestersData.forEach((semester, semesterIndex) => {
                semestersContainer.appendChild(createSemesterElement(semester, semesterIndex));
            });
            summaryContainer.innerHTML = createSummaryElement(summary);
        }
        
        function updateUI() {
            const summary = calculateAll();
            summaryContainer.innerHTML = createSummaryElement(summary);
            
            semestersData.forEach((semester, semesterIndex) => {
                const semesterDiv = semestersContainer.querySelector(`[data-semester-container-index="${semesterIndex}"]`);
                if(semesterDiv){
                    const semesterSummaryDiv = semesterDiv.querySelector('.semester-summary');
                    semesterSummaryDiv.innerHTML = `
                        <span>TC ĐK: <strong class="text-blue-600">${semester.creditsRegistered}</strong></span>
                        <span>TC Đạt: <strong class="text-green-600">${semester.creditsEarned}</strong></span>
                        <span>GPA Kỳ: <strong class="text-purple-600">${semester.gpa.toFixed(2)}</strong></span>
                    `;

                    semester.courses.forEach((course, courseIndex) => {
                         const mainRow = semesterDiv.querySelector(`[data-course-row-index="${courseIndex}"]`);
                         if(mainRow){
                            const score10Display = course.score10 !== null ? course.score10.toFixed(1) : '—';
                            
                            // LOGIC MỚI: Icon cảnh báo
                            let resultIcon;
                            if (course.isIncomplete) {
                                resultIcon = `<i class="fas fa-exclamation-triangle text-xl text-yellow-500" title="Chưa nhập đủ điểm thành phần"></i>`;
                            } else if (course.score10 !== null) {
                                resultIcon = course.passed 
                                    ? `<i class="fas fa-check-circle text-xl text-green-500"></i>` 
                                    : `<i class="fas fa-times-circle text-xl text-red-500"></i>`;
                            } else {
                                resultIcon = '—';
                            }
                            
                            mainRow.cells[4].textContent = score10Display;
                            mainRow.cells[5].className = `p-3 text-center text-lg font-bold ${course.color}`;
                            mainRow.cells[5].textContent = course.letter;
                            mainRow.cells[6].innerHTML = resultIcon;
                            
                            const codeInput = mainRow.querySelector('[data-field="code"]');
                            if(codeInput && codeInput.value !== course.code) codeInput.value = course.code;

                            // Cập nhật cảnh báo trọng số
                            const detailsRow = mainRow.nextElementSibling;
                            if(detailsRow && detailsRow.classList.contains('details-row')){
                                 const weightWarning = course.totalWeight !== 100 ? `<i class="fas fa-exclamation-triangle text-yellow-500 ml-2" title="Tổng trọng số khác 100%"></i>` : '';
                                 const weightSpan = detailsRow.querySelector('.total-weight-display');
                                 if(weightSpan) weightSpan.innerHTML = `Tổng trọng số: <strong class="${course.totalWeight === 100 ? 'text-green-600' : 'text-red-600'}">${course.totalWeight}%</strong>${weightWarning}`;
                            }
                         }
                    });
                }
            });
        }

        function createSemesterElement(semester, semesterIndex) {
            const semesterDiv = document.createElement('div');
            semesterDiv.className = 'semester-container mb-8 bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 fade-in';
            semesterDiv.dataset.semesterContainerIndex = semesterIndex;
            semesterDiv.innerHTML = `
                <div class="bg-gray-50 p-4 flex justify-between items-center border-b border-gray-200">
                    <input type="text" value="${semester.name}" class="semester-name-input text-xl font-bold text-gray-700 bg-transparent focus:ring-0 p-1 w-full md:w-1/2" data-semester-index="${semesterIndex}" placeholder="Nhập tên học kỳ...">
                    <button class="action-btn btn-danger text-sm remove-semester-btn" data-semester-index="${semesterIndex}"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-blue-800"><tr class="table-header">
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider w-12">STT</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider w-32">Mã môn</th>
                            <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider">Tên môn học</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-20">Số TC</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Điểm H10</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Điểm Chữ</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Kết Quả</th>
                            <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider w-24">Thao tác</th>
                        </tr></thead>
                        <tbody class="divide-y divide-gray-200 courses-tbody">
                            ${semester.courses.map((course, courseIndex) => createCourseRow(course, semesterIndex, courseIndex)).join('')}
                            ${semester.courses.length === 0 ? `<tr><td colspan="8" class="empty-course-msg text-center p-8 text-gray-500">Chưa có môn học nào. Hãy thêm hoặc nhập file Excel!</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
                <div class="p-4 bg-gray-50 flex flex-col md:flex-row justify-between items-center border-t gap-4">
                     <div class="semester-summary text-sm font-semibold text-gray-600 space-x-2 md:space-x-4">
                        <span class="block md:inline">TC ĐK: <strong class="text-blue-600">${semester.creditsRegistered}</strong></span>
                        <span class="block md:inline">TC Đạt: <strong class="text-green-600">${semester.creditsEarned}</strong></span>
                        <span class="block md:inline">GPA Kỳ: <strong class="text-purple-600">${semester.gpa.toFixed(2)}</strong></span>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="file-input-${semesterIndex}" class="hidden" accept=".xlsx, .xls, .csv" data-semester-index="${semesterIndex}">
                        <button class="import-excel-trigger action-btn btn-import text-sm" data-semester-index="${semesterIndex}">
                            <i class="fas fa-file-import"></i> Nhập Excel
                        </button>
                        <button class="add-course-btn action-btn btn-primary text-sm" data-semester-index="${semesterIndex}">
                            <i class="fas fa-plus"></i> Thêm Môn
                        </button>
                    </div>
                </div>
            `;
            return semesterDiv;
        }

        function createCourseRow(course, semesterIndex, courseIndex) {
            const score10Display = course.score10 !== null ? course.score10.toFixed(1) : '—';
            
            // LOGIC MỚI: Icon cảnh báo
            let resultIcon;
            if (course.isIncomplete) {
                resultIcon = `<i class="fas fa-exclamation-triangle text-xl text-yellow-500" title="Chưa nhập đủ điểm thành phần"></i>`;
            } else if (course.score10 !== null) {
                resultIcon = course.passed 
                    ? `<i class="fas fa-check-circle text-xl text-green-500"></i>` 
                    : `<i class="fas fa-times-circle text-xl text-red-500"></i>`;
            } else {
                resultIcon = '—';
            }

            const weightWarning = course.totalWeight !== 100 ? `<i class="fas fa-exclamation-triangle text-yellow-500 ml-2" title="Tổng trọng số khác 100%"></i>` : '';

            return `
                <tr class="course-row hover:bg-gray-50" data-course-row-index="${courseIndex}">
                    <td class="p-3 text-center text-sm font-medium text-gray-500">${courseIndex + 1}</td>
                    <td class="p-3"><input type="text" value="${course.code}" class="course-data-input w-full p-1 rounded" data-field="code" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"></td>
                    <td class="p-3"><input type="text" value="${course.name}" class="course-data-input w-full p-1 rounded" data-field="name" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"></td>
                    <td class="p-3"><input type="number" value="${course.credits}" min="0" step="1" class="course-data-input w-full p-1 rounded text-center" data-field="credits" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"></td>
                    <td class="p-3 text-center text-lg font-bold text-blue-600">${score10Display}</td>
                    <td class="p-3 text-center text-lg font-bold ${course.color}">${course.letter}</td>
                    <td class="p-3 text-center">${resultIcon}</td>
                    <td class="p-3 text-center">
                        <button class="icon-btn toggle-details-btn" title="Xem chi tiết" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"><i class="fas fa-chevron-down"></i></button>
                        <button class="icon-btn delete remove-course-btn" title="Xóa môn học" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
                <tr class="details-row"><td colspan="8" class="p-0"><div class="bg-indigo-50 p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-gray-700">Chi tiết điểm: ${course.name}</h4>
                        <span class="total-weight-display text-sm font-medium text-gray-600">Tổng trọng số: <strong class="${course.totalWeight === 100 ? 'text-green-600' : 'text-red-600'}">${course.totalWeight}%</strong>${weightWarning}</span>
                    </div>
                    <table class="min-w-full">
                        <tbody class="components-tbody">
                            ${course.components.map((comp, compIndex) => createComponentRow(comp, semesterIndex, courseIndex, compIndex)).join('')}
                        </tbody>
                    </table>
                    <button class="add-component-btn mt-2 text-sm text-indigo-600 font-semibold hover:text-indigo-800" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}"><i class="fas fa-plus mr-1"></i>Thêm thành phần</button>
                </div></td></tr>
            `;
        }

        function createComponentRow(comp, semesterIndex, courseIndex, compIndex) {
            return `
                <tr class="group" data-comp-index="${compIndex}">
                    <td class="p-2 w-2/3"><input type="text" value="${comp.name}" class="comp-data-input w-full p-1 rounded bg-white" data-field="name" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${compIndex}"></td>
                    <td class="p-2"><input type="number" value="${comp.weight}" placeholder="%" min="0" max="100" class="comp-data-input w-full p-1 rounded text-center bg-white" data-field="weight" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${compIndex}"></td>
                    <td class="p-2"><input type="number" value="${comp.score !== null ? comp.score : ''}" placeholder="Điểm" min="0" max="10" step="0.1" class="comp-data-input w-full p-1 rounded text-center bg-white" data-field="score" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${compIndex}"></td>
                    <td class="p-2 text-center w-12"><button class="icon-btn delete remove-component-btn opacity-50 group-hover:opacity-100" title="Xóa thành phần" data-semester-index="${semesterIndex}" data-course-index="${courseIndex}" data-comp-index="${compIndex}"><i class="fas fa-minus-circle"></i></button></td>
                </tr>`;
        }
        
        function createSummaryElement(summary) {
            const summaryItems = [
                { icon: 'fa-layer-group', label: 'Tổng TC Đăng Ký', value: summary.totalCreditsRegistered, color: 'text-blue-500' },
                { icon: 'fa-check-double', label: 'Tổng TC Tích Lũy', value: summary.totalCreditsAccumulated, color: 'text-green-500' },
                { icon: 'fa-graduation-cap', label: 'GPA Tích Lũy', value: summary.cumulativeGpa.toFixed(2), color: 'text-purple-500' }
            ];
            return `
                <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Tổng Kết Toàn Khóa</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${summaryItems.map(item => `
                        <div class="bg-white p-6 rounded-lg shadow-sm flex items-center gap-4">
                            <i class="fas ${item.icon} ${item.color} text-3xl"></i>
                            <div>
                                <p class="text-sm text-gray-500">${item.label}</p>
                                <p class="text-3xl font-bold ${item.color}">${item.value}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- MODAL & EVENTS ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let confirmCallback = null;

        function showModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            modalConfirmBtn.style.display = onConfirm ? 'inline-flex' : 'none';
            modalCancelBtn.textContent = onConfirm ? 'Hủy bỏ' : 'Đóng';
            modal.classList.add('visible');
        }

        function hideModal() {
            modal.classList.remove('visible');
            confirmCallback = null;
        }

        modalConfirmBtn.onclick = () => {
            if (confirmCallback) confirmCallback();
            hideModal();
        };
        modalCancelBtn.onclick = hideModal;
        modal.onclick = (e) => { if (e.target === modal) hideModal(); };

        // --- EXPORT FUNCTION ---
        function exportToExcel() {
            if (semestersData.length === 0) {
                showModal('Không có dữ liệu', 'Không có dữ liệu nào để xuất.', null);
                return;
            }
            const workbook = XLSX.utils.book_new();
            const date = new Date().toLocaleDateString('vi-VN');
            const summary = calculateAll();
            
            const infoData = [
                ["BẢNG ĐIỂM SMART_GPA PRO"], [],
                ["Ngày xuất:", date], [],
                ["GPA Tích Lũy:", summary.cumulativeGpa.toFixed(2)],
                ["Tín chỉ tích lũy:", summary.totalCreditsAccumulated]
            ];
            const wsInfo = XLSX.utils.aoa_to_sheet(infoData);
            XLSX.utils.book_append_sheet(workbook, wsInfo, "Info");

            semestersData.forEach((sem, idx) => {
                const sheetName = (sem.name.replace(/[:\/?*\[\]\\]/g, "") || `HocKy_${idx+1}`).substring(0, 31);
                const data = [
                    [sem.name.toUpperCase()], [],
                    ["STT", "Mã MH", "Tên Môn Học", "Số TC", "Điểm H10", "Điểm Chữ"]
                ];
                sem.courses.forEach((c, cIdx) => {
                    data.push([
                        cIdx + 1, c.code, c.name, c.credits, 
                        c.score10 !== null ? c.score10 : "", c.letter
                    ]);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(workbook, ws, sheetName);
            });
            XLSX.writeFile(workbook, `BangDiem_${date.replace(/\//g,'-')}.xlsx`);
        }
        
        function getGradeClassification(gpa) {
            if (gpa >= 3.6) return "Xuất sắc";
            if (gpa >= 3.2) return "Giỏi";
            if (gpa >= 2.5) return "Khá";
            if (gpa >= 2.0) return "Trung bình";
            return "Yếu";
        }

        // --- EVENT DELEGATION (CODE MỚI - KHÔNG BỊ NHÁY) ---
        document.body.addEventListener('click', (e) => {
            const target = e.target;

            // 1. SỬA LỖI NHÁY: Thêm Học Kỳ (Dùng appendChild thay vì rerenderAll)
            if (target.closest('#add-semester-btn')) {
                const newIndex = semestersData.length;
                const newSemester = { name: `Học kỳ ${newIndex + 1}`, courses: [] };
                semestersData.push(newSemester);
                
                // Tạo phần tử HTML mới và gắn vào cuối danh sách
                const newElement = createSemesterElement(newSemester, newIndex);
                semestersContainer.appendChild(newElement);
                
                // Chỉ cập nhật số liệu, không vẽ lại giao diện
                updateUI(); 
                
                // Tự động cuộn xuống học kỳ vừa tạo
                newElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            // Các chức năng khác giữ nguyên...
            
            // Export Excel
            if (target.closest('#export-excel-btn')) {
                exportToExcel();
                return;
            }

            // Xóa Học Kỳ (Bắt buộc phải vẽ lại để cập nhật lại index)
            const removeSemesterBtn = target.closest('.remove-semester-btn');
            if(removeSemesterBtn){
                const idx = parseInt(removeSemesterBtn.dataset.semesterIndex);
                showModal('Xóa Học Kỳ?', `Bạn có chắc muốn xóa "${semestersData[idx].name}"?`, () => {
                    semestersData.splice(idx, 1);
                    rerenderAll();
                });
                return;
            }

            // Thêm Môn (Đã tối ưu: Chèn HTML vào bảng)
            const addCourseBtn = target.closest('.add-course-btn');
            if(addCourseBtn){
                const sIdx = parseInt(addCourseBtn.dataset.semesterIndex);
                const cIdx = semestersData[sIdx].courses.length;
                
                // Thêm dữ liệu vào mảng
                semestersData[sIdx].courses.push({ code: "", name: "", credits: 0, score10: null, components: [{ name: "Điểm tổng kết", weight: 100, score: null }], totalWeight: 100 });
                
                // Tìm bảng và chèn dòng mới
                const courseContainer = addCourseBtn.closest('.semester-container').querySelector('.courses-tbody');
                const emptyMsg = courseContainer.querySelector('.empty-course-msg');
                if(emptyMsg) emptyMsg.parentElement.remove();
                
                const newRowHTML = createCourseRow(semestersData[sIdx].courses[cIdx], sIdx, cIdx);
                courseContainer.insertAdjacentHTML('beforeend', newRowHTML);
                
                updateUI();
                return;
            }

            // Xóa Môn (Bắt buộc vẽ lại để cập nhật STT)
            const removeCourseBtn = target.closest('.remove-course-btn');
            if(removeCourseBtn){
                const { semesterIndex, courseIndex } = removeCourseBtn.dataset;
                showModal('Xóa Môn?', `Xóa môn "${semestersData[semesterIndex].courses[courseIndex].name}"?`, () => {
                    semestersData[semesterIndex].courses.splice(courseIndex, 1);
                    rerenderAll();
                });
                return;
            }
            
            // Xóa Thành Phần (Bắt buộc vẽ lại để cập nhật index thành phần)
            const removeCompBtn = target.closest('.remove-component-btn');
            if(removeCompBtn){
                 const { semesterIndex, courseIndex, compIndex } = removeCompBtn.dataset;
                 const comps = semestersData[semesterIndex].courses[courseIndex].components;
                 if(comps.length > 1) {
                     comps.splice(compIndex, 1);
                     rerenderAll();
                 } else {
                     showModal('Lỗi', 'Phải có ít nhất 1 đầu điểm.', null);
                 }
                 return;
            }
            
            // 2. SỬA LỖI NHÁY: Thêm Thành Phần (Dùng insertAdjacentHTML)
            const addCompBtn = target.closest('.add-component-btn');
            if(addCompBtn){
                const { semesterIndex, courseIndex } = addCompBtn.dataset;
                const sIdx = parseInt(semesterIndex);
                const cIdx = parseInt(courseIndex);
                
                // Thêm dữ liệu vào mảng
                semestersData[sIdx].courses[cIdx].components.push({ name: "TP mới", weight: 0, score: null });
                const newCompIndex = semestersData[sIdx].courses[cIdx].components.length - 1;

                // Tìm vị trí chèn trong bảng
                const detailsRow = addCompBtn.closest('.details-row');
                const componentsTbody = detailsRow.querySelector('.components-tbody');
                
                // Tạo HTML dòng mới và chèn vào cuối bảng
                const newRowHTML = createComponentRow(semestersData[sIdx].courses[cIdx].components[newCompIndex], sIdx, cIdx, newCompIndex);
                componentsTbody.insertAdjacentHTML('beforeend', newRowHTML);
                
                updateUI();
                return;
            }

            // Toggle details (Mở rộng/Thu gọn)
            const toggleBtn = target.closest('.toggle-details-btn');
            if (toggleBtn) {
                const row = toggleBtn.closest('tr');
                const nextRow = row.nextElementSibling;
                nextRow.classList.toggle('show');
                const icon = toggleBtn.querySelector('i');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
                return;
            }

            // Nút Import Excel
            const importBtn = target.closest('.import-excel-trigger');
            if(importBtn) {
                const sIdx = importBtn.dataset.semesterIndex;
                const fileInput = document.getElementById(`file-input-${sIdx}`);
                if(fileInput) fileInput.click();
            }
        });

        // --- EVENT: CHANGE INPUT ---
        document.body.addEventListener('input', (e) => {
            const target = e.target;
            const { semesterIndex, courseIndex, compIndex, field } = target.dataset;

            if (target.classList.contains('semester-name-input')) {
                semestersData[target.dataset.semesterIndex].name = target.value;
                return;
            }

            if (field) {
                 const val = target.value;
                 if (target.classList.contains('course-data-input')) {
                     const isNum = target.type === 'number';
                     semestersData[semesterIndex].courses[courseIndex][field] = isNum ? parseFloat(val) || 0 : val;
                 } else if (target.classList.contains('comp-data-input')) {
                     const isNum = target.type === 'number';
                     semestersData[semesterIndex].courses[courseIndex].components[compIndex][field] = isNum ? parseFloat(val) : val;
                 }
                 updateUI(); 
            }
        });

        // --- EVENT: CHANGE INPUT FILE ---
        document.body.addEventListener('change', (e) => {
            if(e.target.type === 'file' && e.target.id.startsWith('file-input-')) {
                const sIdx = e.target.dataset.semesterIndex;
                if(e.target.files.length > 0) {
                    handleImportFile(e.target.files[0], sIdx);
                    e.target.value = '';
                }
            }
        });
        
        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            rerenderAll();
            document.getElementById('save-data-btn').addEventListener('click', saveData);
            document.getElementById('reset-data-btn').addEventListener('click', resetData);
        });
    </script>
</body>
</html>


